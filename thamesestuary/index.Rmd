---
title: "Thames Estuary fish: spawning, recruitment and key areas"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme:
      version: 3          # Use Bootstrap 5
      bg: "#ffffff"       # page background
      fg: "#1d3f7a"       # base text color
      primary: "#1d3f7a"  # brand color (buttons, navbar, links)
---


```{r setup, include=FALSE}
library(flexdashboard)
library(leaflet)
library(leaflet.extras)
library(sf)
library(dplyr)
library(tidyverse)
library(htmltools)
library(htmlwidgets)
```


Home
=======================================================================

Row
-----------------------------------------------------------------------

### Map

```{r}
spawning <- st_read("sp.geojson", quiet = TRUE)
rec <- st_read("rec.geojson", quiet = TRUE)
thames <- st_read("thames.geojson",quiet = TRUE)

to4326 <- function(g) if (!is.na(sf::st_crs(g))) st_transform(g, 4326) else { st_crs(g) <- 4326; g }

spawning   <- to4326(spawning)
rec        <- to4326(rec)
thames <- to4326(thames)

# Recode Olig to Oligohaline for consistency
thames$Zone <- recode(thames$Zone, "Olig" = "Oligohaline")
thames$Zone <- factor(thames$Zone, levels = c("Fresh", "Oligohaline", "Brackish", "Marine"))

# Salinity palette
pal_salinity <- colorFactor(
  palette = c(
    "Fresh" = "#ABD9E9",
    "Oligohaline" = "#74ADD1",
    "Brackish" = "#4575B4",
    "Marine" = "#313695"
  ),
  domain = thames$Zone
)


pal_recruit <- colorFactor(
  palette = c("#FF9800", "#99f542", "green", "#3df5ec", "#4382f0", "#733dd1"),
  domain  = rec$Area, ordered = T)

addLegendCustom <- function(map, colors, labels, opacity = 1, title = NULL, group = NULL, position = "topright") {
  leaflet::addLegend(map, colors = colors, labels = labels, opacity = opacity, title = title, group = group, position = position)
}

# Basic map
leaflet () %>%
  addProviderTiles(providers$CartoDB.Positron, group = "Carto") %>%
  setView(lng = 0.273, lat = 51.49, zoom = 10) %>%
  addPolygons(
    data = thames,
    fillColor = ~pal_salinity(Zone),
    fillOpacity = 0.5,
    color = "black",
    weight = 0.3,
    group = "Thames Estuary",
    popup = ~paste("Zone:", Zone)
  ) %>%
  addPolygons(
    data = rec,
    fillColor = ~pal_recruit(Area),
    fillOpacity = 0.3,
    color = "black",
    weight = 0.3,
    group = "Recruitment",
    popup = ~paste("Area:", Area)
  ) %>%
  addCircleMarkers(
    data = spawning,
    radius = 4,
    fillOpacity = 0.7,
    weight = 1,
    color = "green",
    group = "Spawning",
    popup = ~paste("Species:", Species)) %>%
  addLayersControl(
    overlayGroups = c("Spawning", "Recruitment", "Thames Estuary"),
    options = layersControlOptions(collapsed = FALSE)) %>%
  addLegendCustom(
    colors = c("#ABD9E9", "#74ADD1", "#4575B4", "#313695"),
    labels = c("Tidal fresh (<0.5 ppt)",
               "Oligohaline (0.5–5 ppt)",
               "Brackish (5–30 ppt)",
               "Marine (>30 ppt)"),
    group = "Thames Estuary",
    position = "bottomright",
    title = HTML("Salinity zone<br><small><a href='https://zenodo.org/records/15164384' target='_blank'>Source</a></small>")
  )%>%
  addResetMapButton() %>%
  hideGroup("Thames Estuary")
```




Row
-----------------------------------------------------------------------

### Seasonal life-cycle calendar
| **Season** | **Key biological events**                                                                                                                                                  |
| ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **March–April**    | Smelt migrate upstream to spawn around Putney – Battersea; Dace mass-spawn in Wandsworth; First elvers (~65 mm) arrive.                                      |
| **May**            | Dace larvae (~9 mm) drift downstream; Flounder post-larvae (>8 mm) appear in multiple waves; Smelt fry (~18 mm) present; Bream recruitment begins.             |
| **June**           | Sand smelt spawn in the Greenwich area; Common goby fry (>7–9 mm) appear; First bass fry waves (>12 mm) enter the estuary.                                     |
| **July–August**    | Continued waves of bass fry; High abundance of juvenile goby, flounder, and bass throughout mid–upper estuary.                                                     |
| **September**      | Thin-lipped grey mullet fry (>15–20 mm) arrive; Juvenile bass, smelt, goby and flounder penetrate upriver to Chiswick–Richmond.                                    |
| **October–Winter** | Progressive downstream migration of estuarine and marine species; Freshwater species move downstream as temperatures drop; Adult marine species exit to the North Sea. |

### Recruitment hotspots
| **Area**                    | **Species**                   | 
| --------------------------- | ------------------------------------------------------- |  
| **Richmond**                | Bream, Perch, Roach, Bass fry, Flounder, Goby |               
| **Brentford**               | Bream, Perch                                            |            
| **Putney – Battersea**      | Dace, Smelt                                             |           
| **Chelsea creek**           | Roach                                                   |                 
| **Greenwich**               | Sand smelt                                              |                    
| **Upper Thames (general)** | Goby, Flounder, Smelt fry, Bass fry                     |     
| **Dock basins**             | Smelt                                                   | 


### Areas
| **Area**                                       | **Species**                                          | **Why this area matters**                                                                                                          |
| -------------------------------------------------------- | ----------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| **Richmond – Brentford **                 | Dace, roach, perch, bream; juvenile goby; bass fry; flounder | Primary nursery zone for freshwater and euryhaline juveniles; shallow margins and low salinity provide refuge and feeding habitat. |
| **Putney – Battersea**                               | Dace, Smelt                                                     | Confirmed major spawning corridor: dace (April) and smelt (March–April); crucial upstream migration route.                     |
| **Greenwich**                                       | Sand smelt, smelt fry                                           | Likely spawning area for sand smelt.                             |
| **West Thurrock & below**                           | Sole, plaice, dab, juvenile bass                        | Major flatfish nursery and important marine–estuarine interface; high abundance of juvenile marine fishes.                     |
| **Gravesend & below**                                    | Adult smelt; marine juveniles                                           | Primary entry corridor for marine species; starting point of smelt upstream spawning migration.                                |
| **Dock basins**                                         | Smelt; mixed freshwater & estuarine species                             | Provide refuge habitats with stable temperatures and reduced flow; important overwintering and nursery areas.                  |
| **Soft marginal vegetation**                              | Roundfish fry: dace, smelt, bass                                    | Essential microhabitat for fry using selective tidal stream transport; supports feeding and shelter; increasingly rare.        |
| **Continuous tidal foreshore**                           | Dace fry, smelt larvae, bass fry                                        | Required for uninterrupted fry migrations; heavily reduced (<1% of natural bank remains) due to encroachment and hard engineering. |


Species list
=======================================================================

Row
-----------------------------------------------------------------------


### Species list


<iframe 
  src="https://wandabodnar.github.io/phd/tefish/" 
  width="100%" 
  height="100%" 
  style="border: none;">
</iframe>